@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<FilteredBlockListItem>;
@addTagHelper *, GovUk.Frontend.AspNetCore
@addTagHelper *, GovUk.Frontend.AspNetCore.Extensions
@using GovUk.Frontend.Umbraco
@using GovUk.Frontend.Umbraco.Typography
@using GovUk.Frontend.Umbraco.Models
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Extensions
@{
    var checkboxes = Model.Item.Content.Value<BlockListModel>("checkboxes");
    var modelPropertyName = Model.Item.Settings.Value<string>(PropertyAliases.ModelProperty);
    ViewContext.ModelState.TryGetValue(modelPropertyName, out var modelStateEntry);
    var cssClass = Model.Item.Settings.Value<string>("cssClasses");
    var fieldsetHint = GovUkTypography.Apply(Model.Item.Content.Value<string>("hint"), new TypographyOptions { RemoveWrappingParagraph = true });
    var legendIsPageHeading = Model.Item.Settings.Value<bool>("legendIsPageHeading");
    var legend = Model.Item.Content.Value<string>("legend").Replace("{{name}}", Umbraco.AssignedContentItem.Name);
    var selectedValues = new List<string>();
    if (!string.IsNullOrEmpty(modelStateEntry?.AttemptedValue)) { selectedValues.AddRange(modelStateEntry.AttemptedValue.ToUpperInvariant().Split(",")); }
}

<govuk-client-side-validation error-message-required="@(Model.Item.Settings.Value<string>(PropertyAliases.ErrorMessageRequired))">
    <govuk-checkboxes name="@modelPropertyName" class="@cssClass">
         <govuk-checkboxes-fieldset>
            <govuk-checkboxes-fieldset-legend is-page-heading="@legendIsPageHeading" class="@(legendIsPageHeading ? "govuk-fieldset__legend--l" : null)">@legend</govuk-checkboxes-fieldset-legend>
            @{
                if (!string.IsNullOrWhiteSpace(fieldsetHint))
                {
                    <govuk-checkboxes-hint>@Html.Raw(fieldsetHint)</govuk-checkboxes-hint>
                }
                <govuk-checkboxes-error-message>@(modelStateEntry != null && modelStateEntry.Errors.Any() ? string.Join(". ", modelStateEntry.Errors.Select(x => x.ErrorMessage)) : null)</govuk-checkboxes-error-message>
                foreach (var block in Model.Filter(checkboxes))
                {
                    if (block.Content.ContentType.Alias == "govukCheckboxesDivider")
                    {
                        <govuk-checkboxes-divider>@(string.IsNullOrWhiteSpace(block.Content.Value<string>("text")) ? "or" : block.Content.Value<string>("text"))</govuk-checkboxes-divider>
                    }
                    else
                    {
                        if (block.Settings.Value<bool>("exclusive")) 
                        {
                            var value = block.Content.Value<string>("value");
                            var checkboxHint = GovUkTypography.Apply(block.Content.Value<string>("hint"), new TypographyOptions { RemoveWrappingParagraph = true });
                            <govuk-checkboxes-item value="@value" checked="@(selectedValues.Contains(value.ToUpperInvariant()))" class="@(block.Settings.Value<string>("cssClasses"))" input-data-behaviour="exclusive">@(block.Content.Value<string>("label"))
                                @{
                                    if (!string.IsNullOrWhiteSpace(checkboxHint)) 
                                    {
                                        <govuk-checkboxes-item-hint>@Html.Raw(checkboxHint)</govuk-checkboxes-item-hint>
                                    }
                                    var conditional = block.Content.Value<BlockListModel>("conditionalBlocks");
                                    if (conditional.Any()){
                                        <govuk-checkboxes-item-conditional>
                                            @await Html.PartialAsync("GOVUK/FilteredBlockList", new FilteredBlockListModel(conditional, Model.Filter))
                                        </govuk-checkboxes-item-conditional>
                                    }
                                }
                            </govuk-checkboxes-item>
                        }
                        else
                        {
                            var value = block.Content.Value<string>("value");
                            var checkboxHint = GovUkTypography.Apply(block.Content.Value<string>("hint"), new TypographyOptions { RemoveWrappingParagraph = true });
                            <govuk-checkboxes-item value="@value" checked="@(selectedValues.Contains(value.ToUpperInvariant()))" class="@(block.Settings.Value<string>("cssClasses"))">@(block.Content.Value<string>("label"))
                                @{
                                    if (!string.IsNullOrWhiteSpace(checkboxHint)) 
                                    {
                                        <govuk-checkboxes-item-hint>@Html.Raw(checkboxHint)</govuk-checkboxes-item-hint>
                                    }
                                    var conditional = block.Content.Value<BlockListModel>("conditionalBlocks");
                                    if (conditional.Any()){
                                        <govuk-checkboxes-item-conditional>
                                            @await Html.PartialAsync("GOVUK/FilteredBlockList", new FilteredBlockListModel(conditional, Model.Filter))
                                        </govuk-checkboxes-item-conditional>
                                    }
                                }
                            </govuk-checkboxes-item>                    
                        }
                    }
                }
            }
        </govuk-checkboxes-fieldset>
    </govuk-checkboxes>
</govuk-client-side-validation>