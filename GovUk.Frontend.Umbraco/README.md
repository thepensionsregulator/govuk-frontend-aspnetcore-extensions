# GovUk.Frontend.Umbraco

This builds on [ASP.NET Core MVC tag helpers for GOV.UK Design System](https://github.com/gunndabad/govuk-frontend-aspnetcore) by James Gunn, adding support for:

- ASP.NET client-side validation using [jQuery Unobtrusive Validation](https://github.com/aspnet/jquery-validation-unobtrusive)
- Adding non-interactive components (for example [details](https://design-system.service.gov.uk/components/details/) and [inset text](https://design-system.service.gov.uk/components/inset-text/)) entirely in Umbraco
- Configuring the text for interactive components (for example [text input](https://design-system.service.gov.uk/components/text-input/)) in Umbraco

JQuery is included to support the standard ASP.NET validation. We recommend using vanilla JavaScript for everything else.

This repository includes an example application which demonstrates the validation working both client-side and server-side with messages configured in Umbraco.

## Getting started

1. Clone this repo
2. Run `Install-TPRGitHooks.ps1`
3. Clone https://github.com/gunndabad/govuk-frontend-aspnetcore into a sibling folder called `govuk-frontend-aspnetcore` and checkout the `v1.0` branch
4. Clone the `govuk-frontend` submodule:

   ```pwsh
   git submodule init
   git submodule set-url "lib/govuk-frontend" https://github.com/alphagov/govuk-frontend.git
   git submodule update
   ```

5. In your Umbraco project install [uSync for Umbraco](https://jumoo.co.uk/usync/) using NuGet.
6. Create project references to `GovUk.Frontend.Umbraco`, `GovUk.Frontend.AspNetCore.Extensions` and `GovUk.Frontend.AspNetCore`. This will be replaced by a NuGet references including a package that matches the version of Umbraco you have installed once this project is more complete.
7. Create a file called `Directory.Build.targets` in the root of your Umbraco project with the following content:

   ```xml
   <?xml version="1.0" encoding="utf-8" ?>
   <Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
       <Import Project="$(SolutionDir)..\govuk-frontend-aspnetcore-extensions\GovUk.Frontend.Umbraco\GovUk.Frontend.targets" />
   </Project>
   ```

   Alternatively you can add the `<Import ...>` line to the `.csproj` file.

8. In `appsettings.json` add the following configuration:

   ```json
   {
     "Umbraco": {
       "CMS": {
         "ModelsBuilder": {
           "ModelsMode": "SourceCodeManual",
           "ModelsDirectory": "~/Models/ModelsBuilder"
         }
       }
     }
   }
   ```

9. Rebuild and run your project. On the first run you will see the 'Install Umbraco' screen. Enter your name, email and create a password when prompted.
10. Go to the Umbraco back office at `/umbraco`. Navigate to Settings > uSync. In the 'Everything' box, click 'Import'.
11. On the document type where you want to use GOV.UK components, create a new property that uses the 'GOV.UK Block List' data type. Go to Settings > Models Builder and click 'Generate Models'.
12. On the template/view for the document type, where `Model.Blocks` is the block list property you just created, as represented by the model generated by Umbraco Models Builder for the document type, include the following:

    ```csharp
    <partial name="GOVUK/BlockList" model="Model.Blocks" />
    ```

    If you are using form components your page should look more like this:

    ```csharp
    <partial name="GOVUK/ErrorSummary" />

    <h1 class="govuk-heading-l">@Model.Name</h1>

    @using (Html.BeginUmbracoForm<HomeSurfaceController>(nameof(HomeSurfaceController.Index), null, new { novalidate="novalidate" }))
    {
      <partial name="GOVUK/BlockList" model="Model.Blocks" />
      <govuk-button type="submit">@Model.ButtonText</govuk-button>
    }
    ```

13. Add the following to your `Views/_ViewImports.cshtml` file:

    ```csharp
    @addTagHelper *, GovUk.Frontend.AspNetCore
    @addTagHelper *, GovUk.Frontend.AspNetCore.Extensions
    ```

14. Update your layout to include the GOV.UK Design System scripts. A minimal layout file looks like this:

    ```csharp
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <partial name="GOVUK/Head" />
        @RenderSection("head", required: false)
      </head>
      <body class="govuk-template__body ">
        <partial name="GOVUK/BodyOpen" />
        <main>@RenderBody()</main>
        <partial name="GOVUK/BodyClosing" />
        <partial name="GOVUK/Validation" />
      </body>
    </html>
    ```

    If you do not need form validation on every page you can remove `<partial name="GOVUK/Validation" />` and insert it only on the views where it is required.

    Note that `GOVUK/Head` imports the `/govuk/govuk-frontend-publicsans.css` stylesheet for use [where 'GDS Transport' is not allowed](https://design-system.service.gov.uk/styles/typography/). You can choose to import `/govuk/govuk-frontend.css` instead to use 'GDS Transport', but this does not include the 'Back to top' component.

15. In `Startup.cs` add the following to the `ConfigureServices` method:

    ```csharp
    using GovUk.Frontend.AspNetCore.Extensions;

    public void ConfigureServices(IServiceCollection services)
    {
        // Other code, including services.AddUmbraco()...

        services.AddGovUkFrontendExtensions(options =>
        {
           // Avoid adding scripts which require 'unsafe-inline' in the content security policy
            options.AddImportsToHtml = false;
        });

    }
    ```

16. To use validation, in `Startup.cs` add the following to the `Configure` method:

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Extensions.Options;
    using Umbraco.Cms.Core.Web;

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env, IOptions<MvcOptions> mvcOptions, IUmbracoContextAccessor umbracoContextAccessor)
    {
        // Other code here, including app.UseUmbraco()...

        // Note: two extra services are being injected to the Configure method and used here
        app.UseGovUkFrontendUmbracoExtensions(mvcOptions, umbracoContextAccessor);
    }
    ```

    On your controller and surface controller, add a `ModelType` attribute identifying the type of your view model.

    ```csharp
    using GovUk.Frontend.AspNetCore.Extensions.Validation;

    public class MyDocumentTypeController : RenderController
    {
       private readonly IVariationContextAccessor _variationContextAccessor;
       private readonly ServiceContext _serviceContext;

       public MyDocumentTypeController(ILogger<MyDocumentTypeController> logger,
          ICompositeViewEngine compositeViewEngine,
          IUmbracoContextAccessor umbracoContextAccessor,
          IVariationContextAccessor variationContextAccessor,
          ServiceContext serviceContext) : base(logger, compositeViewEngine, umbracoContextAccessor)
       {
          _variationContextAccessor = variationContextAccessor;
          _serviceContext = serviceContext;
       }

       [ModelType(typeof(MyDocumentType))]
       public override IActionResult Index()
       {
          return CurrentTemplate(new MyDocumentType(CurrentPage, new PublishedValueFallback(_serviceContext, _variationContextAccessor)));
       }

    }
    ```

17. [Add validation rules to your model](https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-mvc-app/validation?view=aspnetcore-5.0) as you normally would for ASP.NET, using attributes from the [System.ComponentModel.DataAnnotations](https://docs.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations?view=net-5.0) namespace.

    You will need a custom view model for this. Add the model generated by Models Builder as a property named `Page` so that it can still be used in the view. For the error message use the name of the property you're applying validation to. This allows `GovUk.Frontend.Umbraco` to look it up and replace it with an error message configured in the Umbraco back office.

    ```csharp
    public class MyDocumentTypeViewModel
    {
       public MyDocumentType Page { get; set; }

       [Required(ErrorMessage = nameof(PropertyToValidate))]
       public int? PropertyToValidate { get; set; }
    }
    ```

## Populating initial values

If you need to select or populate values on your initial GET request, use the `ModelState.SetInitialValues` extension method:

```csharp
/// Controller
using GovUk.Frontend.Umbraco.Validation;

ModelState.SetInitialValue(nameof(viewModel.Field1), Request.Query["field1"]);
```

## Filtering the block list

When using the block list editor, if you need to conditionally hide some of the blocks you can supply a filter. For example, if you wanted to hide all radio buttons where the value is `not-relevant`:

```csharp
/// Model
public class MyDocumentTypeViewModel
{
    public MyDocumentType Page { get; set; }

    public FilteredBlockListModel FilteredBlocks { get; set; }
}

/// Controller
using GovUk.Frontend.Umbraco.Models

viewModel.FilteredBlocks = new FilteredBlockListModel(viewModel.Page.Blocks, model =>
    model.Where(block =>
        block.Content.ContentType.Alias != GovukRadio.ModelTypeAlias ||
        ((GovukRadio)block.Content).Value != "not-relevant")
    );

/// View
<partial name="GOVUK/FilteredBlockList" model="Model.FilteredBlocks" />
```
