@using GovUk.Frontend.Umbraco.Services;
@using ThePensionsRegulator.Umbraco.Blocks;
@using Umbraco.Cms.Core.Models.Blocks
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<IEnumerable<BlockGridItem>>
@inject IEnumerable<IPartialViewPathProvider> pathProviders;
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    var gridModel = Model as OverridableBlockGridModel;
    var blocks = (gridModel?.FilteredBlocks() ?? new OverridableBlockGridModel(Model, null).FilteredBlocks()).ToList();
    if (!blocks.Any()) { return; }

    for (var i = 0; i < blocks.Count; i++)
    {
        if (blocks[i]?.ContentUdi == null) { continue; }

        var pathToView = string.Empty;
        foreach (var pathProvider in pathProviders)
        {
            if (pathProvider.IsProvider(blocks[i]))
            {
                pathToView = pathProvider.BuildPartialViewPath(blocks[i]);
                break;
            }
        }
        if (string.IsNullOrEmpty(pathToView))
        {
            throw new InvalidOperationException(
                $"No {nameof(IPartialViewPathProvider)} was found to provide a path for the block with content key {blocks[i].Content.Key}, of content type {blocks[i].Content.ContentType.Alias}"
            );
        }

        @await Html.PartialAsync(pathToView, blocks[i])
    }
}